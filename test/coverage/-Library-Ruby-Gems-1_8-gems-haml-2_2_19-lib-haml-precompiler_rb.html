<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang='en' xml:lang='en' xmlns='http://www.w3.org/1999/xhtml'>
  <head>
    <title>/Library/Ruby/Gems/1.8/gems/haml-2.2.19/lib/haml/precompiler.rb</title>
    <link href="screen.css" media="all" rel="stylesheet" type="text/css" />
    <link href="print.css" media="print" rel="stylesheet" type="text/css" />
    
    <meta http-equiv="Content-type" content="text/html;charset=UTF-8" />
    <script type="text/javascript" src="rcov.js"></script>
  </head>
  <body>
    <h1>Test C0 Coverage Information - RCov</h1>
    <h2>/Library/Ruby/Gems/1.8/gems/haml-2.2.19/lib/haml/precompiler.rb</h2>

    

    <div class="report_table_wrapper">
      <table class='report' id='report_table'>
        <thead>
          <tr>
            <th class="left_align">Name</th>
            <th class="right_align">Total Lines</th>
            <th class="right_align">Lines of Code</th>
            <th class="left_align">Total Coverage</th>
            <th class="left_align">Code Coverage</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td class="left_align"><a href="-Library-Ruby-Gems-1_8-gems-haml-2_2_19-lib-haml-precompiler_rb.html">/Library/Ruby/Gems/1.8/gems/haml-2.2.19/lib/haml/precompiler.rb</a></td>
            <td class='right_align'><tt>1062</tt></td>
            <td class='right_align'><tt>777</tt></td>
            <td class="left_align"><div class="percent_graph_legend"><tt class=''>74.11%</tt></div>
          <div class="percent_graph">
            <div class="covered" style="width:74px"></div>
            <div class="uncovered" style="width:26px"></div>
          </div></td>
            <td class="left_align"><div class="percent_graph_legend"><tt class=''>67.18%</tt></div>
          <div class="percent_graph">
            <div class="covered" style="width:67px"></div>
            <div class="uncovered" style="width:33px"></div>
          </div></td>
          </tr>
        </tbody>
      </table>
    </div>
    
    <h3>Key</h3>
    
    <div class="key"><pre><span class='marked'>Code reported as executed by Ruby looks like this...</span><span class='marked1'>and this: this line is also marked as covered.</span><span class='inferred'>Lines considered as run by rcov, but not reported by Ruby, look like this,</span><span class='inferred1'>and this: these lines were inferred by rcov (using simple heuristics).</span><span class='uncovered'>Finally, here's a line marked as not executed.</span></pre></div>

    <h3>Coverage Details</h3>

    <table class="details">
      <tbody>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1">1</a> require 'strscan'</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line2">2</a> require 'haml/shared'</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line3">3</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line4">4</a> module Haml</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line5">5</a>   # Handles the internal pre-compilation from Haml into Ruby code,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line6">6</a>   # which then runs the final creation of the HTML string.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line7">7</a>   module Precompiler</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line8">8</a>     include Haml::Util</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line9">9</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line10">10</a>     # Designates an XHTML/XML element.</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line11">11</a>     # @private</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line12">12</a>     ELEMENT         = ?%</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line13">13</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line14">14</a>     # Designates a `&lt;div&gt;` element with the given class.</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line15">15</a>     # @private</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line16">16</a>     DIV_CLASS       = ?.</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line17">17</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line18">18</a>     # Designates a `&lt;div&gt;` element with the given id.</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line19">19</a>     # @private</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line20">20</a>     DIV_ID          = ?#</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line21">21</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line22">22</a>     # Designates an XHTML/XML comment.</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line23">23</a>     # @private</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line24">24</a>     COMMENT         = ?/</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line25">25</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line26">26</a>     # Designates an XHTML doctype or script that is never HTML-escaped.</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line27">27</a>     # @private</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line28">28</a>     DOCTYPE         = ?!</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line29">29</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line30">30</a>     # Designates script, the result of which is output.</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line31">31</a>     # @private</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line32">32</a>     SCRIPT          = ?=</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line33">33</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line34">34</a>     # Designates script that is always HTML-escaped.</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line35">35</a>     # @private</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line36">36</a>     SANITIZE        = ?&amp;</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line37">37</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line38">38</a>     # Designates script, the result of which is flattened and output.</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line39">39</a>     # @private</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line40">40</a>     FLAT_SCRIPT     = ?~</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line41">41</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line42">42</a>     # Designates script which is run but not output.</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line43">43</a>     # @private</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line44">44</a>     SILENT_SCRIPT   = ?-</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line45">45</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line46">46</a>     # When following SILENT_SCRIPT, designates a comment that is not output.</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line47">47</a>     # @private</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line48">48</a>     SILENT_COMMENT  = ?#</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line49">49</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line50">50</a>     # Designates a non-parsed line.</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line51">51</a>     # @private</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line52">52</a>     ESCAPE          = ?\\</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line53">53</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line54">54</a>     # Designates a block of filtered text.</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line55">55</a>     # @private</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line56">56</a>     FILTER          = ?:</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line57">57</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line58">58</a>     # Designates a non-parsed line. Not actually a character.</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line59">59</a>     # @private</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line60">60</a>     PLAIN_TEXT      = -1</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line61">61</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line62">62</a>     # Keeps track of the ASCII values of the characters that begin a</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line63">63</a>     # specially-interpreted line.</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line64">64</a>     # @private</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line65">65</a>     SPECIAL_CHARACTERS   = [</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line66">66</a>       ELEMENT,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line67">67</a>       DIV_CLASS,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line68">68</a>       DIV_ID,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line69">69</a>       COMMENT,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line70">70</a>       DOCTYPE,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line71">71</a>       SCRIPT,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line72">72</a>       SANITIZE,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line73">73</a>       FLAT_SCRIPT,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line74">74</a>       SILENT_SCRIPT,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line75">75</a>       ESCAPE,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line76">76</a>       FILTER</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line77">77</a>     ]</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line78">78</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line79">79</a>     # The value of the character that designates that a line is part</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line80">80</a>     # of a multiline string.</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line81">81</a>     # @private</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line82">82</a>     MULTILINE_CHAR_VALUE = ?|</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line83">83</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line84">84</a>     # Regex to match keywords that appear in the middle of a Ruby block</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line85">85</a>     # with lowered indentation.</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line86">86</a>     # If a block has been started using indentation,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line87">87</a>     # lowering the indentation with one of these won't end the block.</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line88">88</a>     # For example:</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line89">89</a>     #</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line90">90</a>     #   - if foo</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line91">91</a>     #     %p yes!</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line92">92</a>     #   - else</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line93">93</a>     #     %p no!</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line94">94</a>     #</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line95">95</a>     # The block is ended after `%p no!`, because `else`</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line96">96</a>     # is a member of this array.</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line97">97</a>     # @private</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line98">98</a>     MID_BLOCK_KEYWORD_REGEX = /^-\s*(#{%w[else elsif rescue ensure when end].join('|')})\b/</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line99">99</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line100">100</a>     # The Regex that matches a Doctype command.</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line101">101</a>     # @private</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line102">102</a>     DOCTYPE_REGEX = /(\d(?:\.\d)?)?[\s]*([a-z]*)/i</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line103">103</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line104">104</a>     # The Regex that matches a literal string or symbol value</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line105">105</a>     # @private</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line106">106</a>     LITERAL_VALUE_REGEX = /:(\w*)|([&quot;'])((?![\\#]|\2).|\\.)*\2/</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line107">107</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line108">108</a>     private</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line109">109</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line110">110</a>     # Returns the precompiled string with the preamble and postamble</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line111">111</a>     def precompiled_with_ambles(local_names)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line112">112</a>       preamble = &lt;&lt;END.gsub(&quot;\n&quot;, &quot;;&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line113">113</a> begin</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line114">114</a> extend Haml::Helpers</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line115">115</a> _hamlout = @haml_buffer = Haml::Buffer.new(@haml_buffer, #{options_for_buffer.inspect})</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line116">116</a> _erbout = _hamlout.buffer</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line117">117</a> __in_erb_template = true</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line118">118</a> END</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line119">119</a>       postamble = &lt;&lt;END.gsub(&quot;\n&quot;, &quot;;&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line120">120</a> #{precompiled_method_return_value}</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line121">121</a> ensure</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line122">122</a> @haml_buffer = @haml_buffer.upper</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line123">123</a> end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line124">124</a> END</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line125">125</a>       preamble + locals_code(local_names) + precompiled + postamble</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line126">126</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line127">127</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line128">128</a>     # Returns the string used as the return value of the precompiled method.</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line129">129</a>     # This method exists so it can be monkeypatched to return modified values.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line130">130</a>     def precompiled_method_return_value</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line131">131</a>       &quot;_erbout&quot;</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line132">132</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line133">133</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line134">134</a>     def locals_code(names)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line135">135</a>       names = names.keys if Hash == names</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line136">136</a> </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line137">137</a>       names.map do |name|</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line138">138</a>         # Can't use || because someone might explicitly pass in false with a symbol</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line139">139</a>         sym_local = &quot;_haml_locals[#{name.to_sym.inspect}]&quot;</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line140">140</a>         str_local = &quot;_haml_locals[#{name.to_s.inspect}]&quot;</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line141">141</a>         &quot;#{name} = #{sym_local}.nil? ? #{str_local} : #{sym_local}&quot;</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line142">142</a>       end.join(';') + ';'</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line143">143</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line144">144</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line145">145</a>     # @private</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line146">146</a>     class Line &lt; Struct.new(:text, :unstripped, :full, :index, :precompiler, :eod)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line147">147</a>       alias_method :eod?, :eod</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line148">148</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line149">149</a>       def tabs</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line150">150</a>         line = self</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line151">151</a>         @tabs ||= precompiler.instance_eval do</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line152">152</a>           break 0 if line.text.empty? || !(whitespace = line.full[/^\s+/])</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line153">153</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line154">154</a>           if @indentation.nil?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line155">155</a>             @indentation = whitespace</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line156">156</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line157">157</a>             if @indentation.include?(?\s) &amp;&amp; @indentation.include?(?\t)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line158">158</a>               raise SyntaxError.new(&quot;Indentation can't use both tabs and spaces.&quot;, line.index)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line159">159</a>             end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line160">160</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line161">161</a>             @flat_spaces = @indentation * @template_tabs if flat?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line162">162</a>             break 1</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line163">163</a>           end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line164">164</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line165">165</a>           tabs = whitespace.length / @indentation.length</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line166">166</a>           break tabs if whitespace == @indentation * tabs</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line167">167</a>           break @template_tabs if flat? &amp;&amp; whitespace =~ /^#{@indentation * @template_tabs}/</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line168">168</a> </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line169">169</a>           raise SyntaxError.new(&lt;&lt;END.strip.gsub(&quot;\n&quot;, ' '), line.index)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line170">170</a> Inconsistent indentation: #{Haml::Shared.human_indentation whitespace, true} used for indentation,</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line171">171</a> but the rest of the document was indented using #{Haml::Shared.human_indentation @indentation}.</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line172">172</a> END</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line173">173</a>         end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line174">174</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line175">175</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line176">176</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line177">177</a>     def precompile</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line178">178</a>       @haml_comment = @dont_indent_next_line = @dont_tab_up_next_text = false</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line179">179</a>       @indentation = nil</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line180">180</a>       @line = next_line</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line181">181</a>       resolve_newlines</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line182">182</a>       newline</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line183">183</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line184">184</a>       raise SyntaxError.new(&quot;Indenting at the beginning of the document is illegal.&quot;, @line.index) if @line.tabs != 0</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line185">185</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line186">186</a>       while next_line</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line187">187</a>         process_indent(@line) unless @line.text.empty?</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line188">188</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line189">189</a>         if flat?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line190">190</a>           push_flat(@line)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line191">191</a>           @line = @next_line</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line192">192</a>           newline</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line193">193</a>           next</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line194">194</a>         end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line195">195</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line196">196</a>         process_line(@line.text, @line.index) unless @line.text.empty? || @haml_comment</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line197">197</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line198">198</a>         if !flat? &amp;&amp; @next_line.tabs - @line.tabs &gt; 1</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line199">199</a>           raise SyntaxError.new(&quot;The line was indented #{@next_line.tabs - @line.tabs} levels deeper than the previous line.&quot;, @next_line.index)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line200">200</a>         end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line201">201</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line202">202</a>         resolve_newlines unless @next_line.eod?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line203">203</a>         @line = @next_line</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line204">204</a>         newline unless @next_line.eod?</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line205">205</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line206">206</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line207">207</a>       # Close all the open tags</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line208">208</a>       close until @to_close_stack.empty?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line209">209</a>       flush_merged_text</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line210">210</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line211">211</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line212">212</a>     # Processes and deals with lowering indentation.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line213">213</a>     def process_indent(line)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line214">214</a>       return unless line.tabs &lt;= @template_tabs &amp;&amp; @template_tabs &gt; 0</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line215">215</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line216">216</a>       to_close = @template_tabs - line.tabs</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line217">217</a>       to_close.times {|i| close unless to_close - 1 - i == 0 &amp;&amp; mid_block_keyword?(line.text)}</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line218">218</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line219">219</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line220">220</a>     # Processes a single line of Haml.</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line221">221</a>     #</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line222">222</a>     # This method doesn't return anything; it simply processes the line and</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line223">223</a>     # adds the appropriate code to `@precompiled`.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line224">224</a>     def process_line(text, index)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line225">225</a>       @index = index + 1</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line226">226</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line227">227</a>       case text[0]</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line228">228</a>       when DIV_CLASS; render_div(text)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line229">229</a>       when DIV_ID</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line230">230</a>         return push_plain(text) if text[1] == ?{</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line231">231</a>         render_div(text)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line232">232</a>       when ELEMENT; render_tag(text)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line233">233</a>       when COMMENT; render_comment(text[1..-1].strip)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line234">234</a>       when SANITIZE</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line235">235</a>         return push_plain(text[3..-1].strip, :escape_html =&gt; true) if text[1..2] == &quot;==&quot;</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line236">236</a>         return push_script(text[2..-1].strip, :escape_html =&gt; true) if text[1] == SCRIPT</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line237">237</a>         return push_flat_script(text[2..-1].strip, :escape_html =&gt; true) if text[1] == FLAT_SCRIPT</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line238">238</a>         return push_plain(text[1..-1].strip, :escape_html =&gt; true) if text[1] == ?\s</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line239">239</a>         push_plain text</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line240">240</a>       when SCRIPT</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line241">241</a>         return push_plain(text[2..-1].strip) if text[1] == SCRIPT</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line242">242</a>         push_script(text[1..-1])</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line243">243</a>       when FLAT_SCRIPT; push_flat_script(text[1..-1])</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line244">244</a>       when SILENT_SCRIPT</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line245">245</a>         return start_haml_comment if text[1] == SILENT_COMMENT</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line246">246</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line247">247</a>         raise SyntaxError.new(&lt;&lt;END.rstrip, index) if text[1..-1].strip == &quot;end&quot;</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line248">248</a> You don't need to use &quot;- end&quot; in Haml. Use indentation instead:</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line249">249</a> - if foo?</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line250">250</a>   %strong Foo!</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line251">251</a> - else</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line252">252</a>   Not foo.</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line253">253</a> END</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line254">254</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line255">255</a>         push_silent(text[1..-1], true)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line256">256</a>         newline_now</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line257">257</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line258">258</a>         # Handle stuff like - end.join(&quot;|&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line259">259</a>         @to_close_stack.last &lt;&lt; false if text =~ /^-\s*end\b/ &amp;&amp; !block_opened?</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line260">260</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line261">261</a>         case_stmt = text =~ /^-\s*case\b/</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line262">262</a>         keyword = mid_block_keyword?(text)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line263">263</a>         block = block_opened? &amp;&amp; !keyword</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line264">264</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line265">265</a>         # It's important to preserve tabulation modification for keywords</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line266">266</a>         # that involve choosing between posible blocks of code.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line267">267</a>         if %w[else elsif when].include?(keyword)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line268">268</a>           # @to_close_stack may not have a :script on top</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line269">269</a>           # when the preceding &quot;- if&quot; has nothing nested</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line270">270</a>           if @to_close_stack.last &amp;&amp; @to_close_stack.last.first == :script</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line271">271</a>             @dont_indent_next_line, @dont_tab_up_next_text = @to_close_stack.last[1..2]</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line272">272</a>           else</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line273">273</a>             push_and_tabulate([:script, @dont_indent_next_line, @dont_tab_up_next_text])</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line274">274</a>           end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line275">275</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line276">276</a>           # when is unusual in that either it will be indented twice,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line277">277</a>           # or the case won't have created its own indentation</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line278">278</a>           if keyword == &quot;when&quot;</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line279">279</a>             push_and_tabulate([:script, @dont_indent_next_line, @dont_tab_up_next_text, false])</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line280">280</a>           end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line281">281</a>         elsif block || case_stmt</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line282">282</a>           push_and_tabulate([:script, @dont_indent_next_line, @dont_tab_up_next_text])</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line283">283</a>         elsif block &amp;&amp; case_stmt</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line284">284</a>           push_and_tabulate([:script, @dont_indent_next_line, @dont_tab_up_next_text])</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line285">285</a>         end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line286">286</a>       when FILTER; start_filtered(text[1..-1].downcase)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line287">287</a>       when DOCTYPE</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line288">288</a>         return render_doctype(text) if text[0...3] == '!!!'</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line289">289</a>         return push_plain(text[3..-1].strip, :escape_html =&gt; false) if text[1..2] == &quot;==&quot;</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line290">290</a>         return push_script(text[2..-1].strip, :escape_html =&gt; false) if text[1] == SCRIPT</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line291">291</a>         return push_flat_script(text[2..-1].strip, :escape_html =&gt; false) if text[1] == FLAT_SCRIPT</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line292">292</a>         return push_plain(text[1..-1].strip, :escape_html =&gt; false) if text[1] == ?\s</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line293">293</a>         push_plain text</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line294">294</a>       when ESCAPE; push_plain text[1..-1]</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line295">295</a>       else push_plain text</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line296">296</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line297">297</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line298">298</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line299">299</a>     # If the text is a silent script text with one of Ruby's mid-block keywords,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line300">300</a>     # returns the name of that keyword.</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line301">301</a>     # Otherwise, returns nil.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line302">302</a>     def mid_block_keyword?(text)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line303">303</a>       text[MID_BLOCK_KEYWORD_REGEX, 1]</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line304">304</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line305">305</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line306">306</a>     # Evaluates `text` in the context of the scope object, but</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line307">307</a>     # does not output the result.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line308">308</a>     def push_silent(text, can_suppress = false)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line309">309</a>       flush_merged_text</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line310">310</a>       return if can_suppress &amp;&amp; options[:suppress_eval]</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line311">311</a>       @precompiled &lt;&lt; &quot;#{text};&quot;</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line312">312</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line313">313</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line314">314</a>     # Adds `text` to `@buffer` with appropriate tabulation</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line315">315</a>     # without parsing it.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line316">316</a>     def push_merged_text(text, tab_change = 0, indent = true)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line317">317</a>       text = !indent || @dont_indent_next_line || @options[:ugly] ? text : &quot;#{'  ' * @output_tabs}#{text}&quot;</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line318">318</a>       @to_merge &lt;&lt; [:text, text, tab_change]</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line319">319</a>       @dont_indent_next_line = false</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line320">320</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line321">321</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line322">322</a>     # Concatenate `text` to `@buffer` without tabulation.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line323">323</a>     def concat_merged_text(text)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line324">324</a>       @to_merge &lt;&lt; [:text, text, 0]</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line325">325</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line326">326</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line327">327</a>     def push_text(text, tab_change = 0)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line328">328</a>       push_merged_text(&quot;#{text}\n&quot;, tab_change)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line329">329</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line330">330</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line331">331</a>     def flush_merged_text</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line332">332</a>       return if @to_merge.empty?</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line333">333</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line334">334</a>       text, tab_change = @to_merge.inject([&quot;&quot;, 0]) do |(str, mtabs), (type, val, tabs)|</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line335">335</a>         case type</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line336">336</a>         when :text</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line337">337</a>           [str &lt;&lt; val.inspect[1...-1], mtabs + tabs]</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line338">338</a>         when :script</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line339">339</a>           if mtabs != 0 &amp;&amp; !@options[:ugly]</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line340">340</a>             val = &quot;_hamlout.adjust_tabs(#{mtabs}); &quot; + val</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line341">341</a>           end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line342">342</a>           [str &lt;&lt; &quot;\#{#{val}}&quot;, 0]</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line343">343</a>         else</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line344">344</a>           raise SyntaxError.new(&quot;[HAML BUG] Undefined entry in Haml::Precompiler@to_merge.&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line345">345</a>         end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line346">346</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line347">347</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line348">348</a>       @precompiled &lt;&lt;</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line349">349</a>         if @options[:ugly]</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line350">350</a>           &quot;_hamlout.buffer &lt;&lt; \&quot;#{text}\&quot;;&quot;</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line351">351</a>         else</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line352">352</a>           &quot;_hamlout.push_text(\&quot;#{text}\&quot;, #{tab_change}, #{@dont_tab_up_next_text.inspect});&quot;</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line353">353</a>         end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line354">354</a>       @to_merge = []</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line355">355</a>       @dont_tab_up_next_text = false</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line356">356</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line357">357</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line358">358</a>     # Renders a block of text as plain text.</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line359">359</a>     # Also checks for an illegally opened block.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line360">360</a>     def push_plain(text, options = {})</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line361">361</a>       if block_opened?</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line362">362</a>         raise SyntaxError.new(&quot;Illegal nesting: nesting within plain text is illegal.&quot;, @next_line.index)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line363">363</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line364">364</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line365">365</a>       if contains_interpolation?(text)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line366">366</a>         options[:escape_html] = self.options[:escape_html] if options[:escape_html].nil?</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line367">367</a>         push_script(</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line368">368</a>           unescape_interpolation(text, :escape_html =&gt; options[:escape_html]),</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line369">369</a>           :escape_html =&gt; false)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line370">370</a>       else</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line371">371</a>         push_text text</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line372">372</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line373">373</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line374">374</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line375">375</a>     # Adds +text+ to `@buffer` while flattening text.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line376">376</a>     def push_flat(line)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line377">377</a>       text = line.full.dup</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line378">378</a>       text = &quot;&quot; unless text.gsub!(/^#{@flat_spaces}/, '')</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line379">379</a>       @filter_buffer &lt;&lt; &quot;#{text}\n&quot;</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line380">380</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line381">381</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line382">382</a>     # Causes `text` to be evaluated in the context of</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line383">383</a>     # the scope object and the result to be added to `@buffer`.</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line384">384</a>     #</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line385">385</a>     # If `opts[:preserve_script]` is true, Haml::Helpers#find_and_flatten is run on</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line386">386</a>     # the result before it is added to `@buffer`</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line387">387</a>     def push_script(text, opts = {})</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line388">388</a>       raise SyntaxError.new(&quot;There's no Ruby code for = to evaluate.&quot;) if text.empty?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line389">389</a>       return if options[:suppress_eval]</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line390">390</a>       opts[:escape_html] = options[:escape_html] if opts[:escape_html].nil?</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line391">391</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line392">392</a>       args = %w[preserve_script in_tag preserve_tag escape_html nuke_inner_whitespace]</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line393">393</a>       args.map! {|name| opts[name.to_sym]}</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line394">394</a>       args &lt;&lt; !block_opened? &lt;&lt; @options[:ugly]</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line395">395</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line396">396</a>       no_format = @options[:ugly] &amp;&amp;</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line397">397</a>         !(opts[:preserve_script] || opts[:preserve_tag] || opts[:escape_html])</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line398">398</a>       output_temp = &quot;(haml_very_temp = haml_temp; haml_temp = nil; haml_very_temp)&quot;</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line399">399</a>       out = &quot;_hamlout.#{static_method_name(:format_script, *args)}(#{output_temp});&quot;</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line400">400</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line401">401</a>       # Prerender tabulation unless we're in a tag</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line402">402</a>       push_merged_text '' unless opts[:in_tag]</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line403">403</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line404">404</a>       unless block_opened?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line405">405</a>         @to_merge &lt;&lt; [:script, no_format ? &quot;#{text}\n&quot; : &quot;haml_temp = #{text}\n#{out}&quot;]</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line406">406</a>         concat_merged_text(&quot;\n&quot;) unless opts[:in_tag] || opts[:nuke_inner_whitespace]</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line407">407</a>         @newlines -= 1</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line408">408</a>         return</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line409">409</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line410">410</a> </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line411">411</a>       flush_merged_text</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line412">412</a> </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line413">413</a>       push_silent &quot;haml_temp = #{text}&quot;</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line414">414</a>       newline_now</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line415">415</a>       push_and_tabulate([:loud, &quot;_hamlout.buffer &lt;&lt; #{no_format ? &quot;#{output_temp}.to_s;&quot; : out}&quot;,</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line416">416</a>         !(opts[:in_tag] || opts[:nuke_inner_whitespace] || @options[:ugly])])</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line417">417</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line418">418</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line419">419</a>     # Causes `text` to be evaluated, and Haml::Helpers#find_and_flatten</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line420">420</a>     # to be run on it afterwards.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line421">421</a>     def push_flat_script(text, options = {})</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line422">422</a>       flush_merged_text</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line423">423</a> </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line424">424</a>       raise SyntaxError.new(&quot;There's no Ruby code for ~ to evaluate.&quot;) if text.empty?</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line425">425</a>       push_script(text, options.merge(:preserve_script =&gt; true))</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line426">426</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line427">427</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line428">428</a>     def start_haml_comment</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line429">429</a>       return unless block_opened?</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line430">430</a> </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line431">431</a>       @haml_comment = true</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line432">432</a>       push_and_tabulate([:haml_comment])</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line433">433</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line434">434</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line435">435</a>     # Closes the most recent item in `@to_close_stack`.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line436">436</a>     def close</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line437">437</a>       tag, *rest = @to_close_stack.pop</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line438">438</a>       send(&quot;close_#{tag}&quot;, *rest)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line439">439</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line440">440</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line441">441</a>     # Puts a line in `@precompiled` that will add the closing tag of</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line442">442</a>     # the most recently opened tag.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line443">443</a>     def close_element(value)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line444">444</a>       tag, nuke_outer_whitespace, nuke_inner_whitespace = value</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line445">445</a>       @output_tabs -= 1 unless nuke_inner_whitespace</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line446">446</a>       @template_tabs -= 1</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line447">447</a>       rstrip_buffer! if nuke_inner_whitespace</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line448">448</a>       push_merged_text(&quot;&lt;/#{tag}&gt;&quot; + (nuke_outer_whitespace ? &quot;&quot; : &quot;\n&quot;),</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line449">449</a>                        nuke_inner_whitespace ? 0 : -1, !nuke_inner_whitespace)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line450">450</a>       @dont_indent_next_line = nuke_outer_whitespace</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line451">451</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line452">452</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line453">453</a>     # Closes a Ruby block.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line454">454</a>     def close_script(_1, _2, push_end = true)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line455">455</a>       push_silent(&quot;end&quot;, true) if push_end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line456">456</a>       @template_tabs -= 1</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line457">457</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line458">458</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line459">459</a>     # Closes a comment.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line460">460</a>     def close_comment(has_conditional)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line461">461</a>       @output_tabs -= 1</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line462">462</a>       @template_tabs -= 1</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line463">463</a>       close_tag = has_conditional ? &quot;&lt;![endif]--&gt;&quot; : &quot;--&gt;&quot;</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line464">464</a>       push_text(close_tag, -1)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line465">465</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line466">466</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line467">467</a>     # Closes a loud Ruby block.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line468">468</a>     def close_loud(command, add_newline, push_end = true)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line469">469</a>       push_silent('end', true) if push_end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line470">470</a>       @precompiled &lt;&lt; command</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line471">471</a>       @template_tabs -= 1</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line472">472</a>       concat_merged_text(&quot;\n&quot;) if add_newline</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line473">473</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line474">474</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line475">475</a>     # Closes a filtered block.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line476">476</a>     def close_filtered(filter)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line477">477</a>       filter.internal_compile(self, @filter_buffer)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line478">478</a>       @flat = false</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line479">479</a>       @flat_spaces = nil</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line480">480</a>       @filter_buffer = nil</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line481">481</a>       @template_tabs -= 1</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line482">482</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line483">483</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line484">484</a>     def close_haml_comment</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line485">485</a>       @haml_comment = false</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line486">486</a>       @template_tabs -= 1</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line487">487</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line488">488</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line489">489</a>     def close_nil(*args)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line490">490</a>       @template_tabs -= 1</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line491">491</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line492">492</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line493">493</a>     # Iterates through the classes and ids supplied through `.`</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line494">494</a>     # and `#` syntax, and returns a hash with them as attributes,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line495">495</a>     # that can then be merged with another attributes hash.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line496">496</a>     def parse_class_and_id(list)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line497">497</a>       attributes = {}</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line498">498</a>       list.scan(/([#.])([-_a-zA-Z0-9]+)/) do |type, property|</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line499">499</a>         case type</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line500">500</a>         when '.'</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line501">501</a>           if attributes['class']</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line502">502</a>             attributes['class'] += &quot; &quot;</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line503">503</a>           else</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line504">504</a>             attributes['class'] = &quot;&quot;</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line505">505</a>           end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line506">506</a>           attributes['class'] += property</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line507">507</a>         when '#'; attributes['id'] = property</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line508">508</a>         end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line509">509</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line510">510</a>       attributes</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line511">511</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line512">512</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line513">513</a>     def parse_static_hash(text)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line514">514</a>       attributes = {}</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line515">515</a>       scanner = StringScanner.new(text)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line516">516</a>       scanner.scan(/\s+/)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line517">517</a>       until scanner.eos?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line518">518</a>         return unless key = scanner.scan(LITERAL_VALUE_REGEX)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line519">519</a>         return unless scanner.scan(/\s*=&gt;\s*/)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line520">520</a>         return unless value = scanner.scan(LITERAL_VALUE_REGEX)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line521">521</a>         return unless scanner.scan(/\s*(?:,|$)\s*/)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line522">522</a>         attributes[eval(key).to_s] = eval(value).to_s</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line523">523</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line524">524</a>       text.count(&quot;\n&quot;).times { newline }</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line525">525</a>       attributes</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line526">526</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line527">527</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line528">528</a>     # This is a class method so it can be accessed from Buffer.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line529">529</a>     def self.build_attributes(is_html, attr_wrapper, attributes = {})</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line530">530</a>       quote_escape = attr_wrapper == '&quot;' ? &quot;&amp;quot;&quot; : &quot;&amp;apos;&quot;</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line531">531</a>       other_quote_char = attr_wrapper == '&quot;' ? &quot;'&quot; : '&quot;'</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line532">532</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line533">533</a>       result = attributes.collect do |attr, value|</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line534">534</a>         next if value.nil?</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line535">535</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line536">536</a>         if value == true</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line537">537</a>           next &quot; #{attr}&quot; if is_html</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line538">538</a>           next &quot; #{attr}=#{attr_wrapper}#{attr}#{attr_wrapper}&quot;</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line539">539</a>         elsif value == false</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line540">540</a>           next</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line541">541</a>         end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line542">542</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line543">543</a>         value = Haml::Helpers.preserve(Haml::Helpers.escape_once(value.to_s))</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line544">544</a>         # We want to decide whether or not to escape quotes</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line545">545</a>         value.gsub!('&amp;quot;', '&quot;')</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line546">546</a>         this_attr_wrapper = attr_wrapper</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line547">547</a>         if value.include? attr_wrapper</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line548">548</a>           if value.include? other_quote_char</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line549">549</a>             value = value.gsub(attr_wrapper, quote_escape)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line550">550</a>           else</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line551">551</a>             this_attr_wrapper = other_quote_char</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line552">552</a>           end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line553">553</a>         end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line554">554</a>         &quot; #{attr}=#{this_attr_wrapper}#{value}#{this_attr_wrapper}&quot;</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line555">555</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line556">556</a>       result.compact.sort.join</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line557">557</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line558">558</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line559">559</a>     def prerender_tag(name, self_close, attributes)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line560">560</a>       attributes_string = Precompiler.build_attributes(html?, @options[:attr_wrapper], attributes)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line561">561</a>       &quot;&lt;#{name}#{attributes_string}#{self_close &amp;&amp; xhtml? ? ' /' : ''}&gt;&quot;</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line562">562</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line563">563</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line564">564</a>     # Parses a line into tag_name, attributes, attributes_hash, object_ref, action, value</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line565">565</a>     def parse_tag(line)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line566">566</a>       raise SyntaxError.new(&quot;Invalid tag: \&quot;#{line}\&quot;.&quot;) unless match = line.scan(/%([-:\w]+)([-\w\.\#]*)(.*)/)[0]</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line567">567</a>       tag_name, attributes, rest = match</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line568">568</a>       new_attributes_hash = old_attributes_hash = last_line = object_ref = nil</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line569">569</a>       attributes_hashes = []</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line570">570</a>       while rest</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line571">571</a>         case rest[0]</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line572">572</a>         when ?{</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line573">573</a>           break if old_attributes_hash</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line574">574</a>           old_attributes_hash, rest, last_line = parse_old_attributes(rest)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line575">575</a>           attributes_hashes &lt;&lt; [:old, old_attributes_hash]</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line576">576</a>         when ?(</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line577">577</a>           break if new_attributes_hash</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line578">578</a>           new_attributes_hash, rest, last_line = parse_new_attributes(rest)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line579">579</a>           attributes_hashes &lt;&lt; [:new, new_attributes_hash]</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line580">580</a>         when ?[</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line581">581</a>           break if object_ref</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line582">582</a>           object_ref, rest = balance(rest, ?[, ?])</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line583">583</a>         else; break</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line584">584</a>         end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line585">585</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line586">586</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line587">587</a>       if rest</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line588">588</a>         nuke_whitespace, action, value = rest.scan(/(&lt;&gt;|&gt;&lt;|[&gt;&lt;])?([=\/\~&amp;!])?(.*)?/)[0]</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line589">589</a>         nuke_whitespace ||= ''</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line590">590</a>         nuke_outer_whitespace = nuke_whitespace.include? '&gt;'</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line591">591</a>         nuke_inner_whitespace = nuke_whitespace.include? '&lt;'</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line592">592</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line593">593</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line594">594</a>       value = value.to_s.strip</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line595">595</a>       [tag_name, attributes, attributes_hashes, object_ref, nuke_outer_whitespace,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line596">596</a>        nuke_inner_whitespace, action, value, last_line || @index]</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line597">597</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line598">598</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line599">599</a>     def parse_old_attributes(line)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line600">600</a>       line = line.dup</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line601">601</a>       last_line = @index</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line602">602</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line603">603</a>       begin</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line604">604</a>         attributes_hash, rest = balance(line, ?{, ?})</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line605">605</a>       rescue SyntaxError =&gt; e</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line606">606</a>         if line.strip[-1] == ?, &amp;&amp; e.message == &quot;Unbalanced brackets.&quot;</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line607">607</a>           line &lt;&lt; &quot;\n&quot; &lt;&lt; @next_line.text</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line608">608</a>           last_line += 1</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line609">609</a>           next_line</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line610">610</a>           retry</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line611">611</a>         end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line612">612</a> </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line613">613</a>         raise e</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line614">614</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line615">615</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line616">616</a>       attributes_hash = attributes_hash[1...-1] if attributes_hash</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line617">617</a>       return attributes_hash, rest, last_line</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line618">618</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line619">619</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line620">620</a>     def parse_new_attributes(line)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line621">621</a>       line = line.dup</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line622">622</a>       scanner = StringScanner.new(line)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line623">623</a>       last_line = @index</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line624">624</a>       attributes = {}</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line625">625</a> </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line626">626</a>       scanner.scan(/\(\s*/)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line627">627</a>       loop do</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line628">628</a>         name, value = parse_new_attribute(scanner)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line629">629</a>         break if name.nil?</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line630">630</a> </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line631">631</a>         if name == false</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line632">632</a>           text = (Haml::Shared.balance(line, ?(, ?)) || [line]).first</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line633">633</a>           raise Haml::SyntaxError.new(&quot;Invalid attribute list: #{text.inspect}.&quot;, last_line - 1)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line634">634</a>         end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line635">635</a>         attributes[name] = value</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line636">636</a>         scanner.scan(/\s*/)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line637">637</a> </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line638">638</a>         if scanner.eos?</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line639">639</a>           line &lt;&lt; &quot; &quot; &lt;&lt; @next_line.text</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line640">640</a>           last_line += 1</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line641">641</a>           next_line</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line642">642</a>           scanner.scan(/\s*/)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line643">643</a>         end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line644">644</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line645">645</a> </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line646">646</a>       static_attributes = {}</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line647">647</a>       dynamic_attributes = &quot;{&quot;</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line648">648</a>       attributes.each do |name, (type, val)|</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line649">649</a>         if type == :static</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line650">650</a>           static_attributes[name] = val</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line651">651</a>         else</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line652">652</a>           dynamic_attributes &lt;&lt; name.inspect &lt;&lt; &quot; =&gt; &quot; &lt;&lt; val &lt;&lt; &quot;,&quot;</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line653">653</a>         end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line654">654</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line655">655</a>       dynamic_attributes &lt;&lt; &quot;}&quot;</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line656">656</a>       dynamic_attributes = nil if dynamic_attributes == &quot;{}&quot;</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line657">657</a> </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line658">658</a>       return [static_attributes, dynamic_attributes], scanner.rest, last_line</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line659">659</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line660">660</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line661">661</a>     def parse_new_attribute(scanner)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line662">662</a>       unless name = scanner.scan(/[-:\w]+/)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line663">663</a>         return if scanner.scan(/\)/)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line664">664</a>         return false</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line665">665</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line666">666</a> </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line667">667</a>       scanner.scan(/\s*/)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line668">668</a>       return name, [:static, true] unless scanner.scan(/=/) #/end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line669">669</a> </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line670">670</a>       scanner.scan(/\s*/)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line671">671</a>       unless quote = scanner.scan(/[&quot;']/)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line672">672</a>         return false unless var = scanner.scan(/(@@?|\$)?\w+/)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line673">673</a>         return name, [:dynamic, var]</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line674">674</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line675">675</a> </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line676">676</a>       re = /((?:\\.|\#(?!\{)|[^#{quote}\\#])*)(#{quote}|#\{)/</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line677">677</a>       content = []</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line678">678</a>       loop do</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line679">679</a>         return false unless scanner.scan(re)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line680">680</a>         content &lt;&lt; [:str, scanner[1].gsub(/\\(.)/, '\1')]</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line681">681</a>         break if scanner[2] == quote</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line682">682</a>         content &lt;&lt; [:ruby, balance(scanner, ?{, ?}, 1).first[0...-1]]</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line683">683</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line684">684</a> </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line685">685</a>       return name, [:static, content.first[1]] if content.size == 1</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line686">686</a>       return name, [:dynamic,</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line687">687</a>         '&quot;' + content.map {|(t, v)| t == :str ? v.inspect[1...-1] : &quot;\#{#{v}}&quot;}.join + '&quot;']</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line688">688</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line689">689</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line690">690</a>     # Parses a line that will render as an XHTML tag, and adds the code that will</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line691">691</a>     # render that tag to `@precompiled`.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line692">692</a>     def render_tag(line)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line693">693</a>       tag_name, attributes, attributes_hashes, object_ref, nuke_outer_whitespace,</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line694">694</a>         nuke_inner_whitespace, action, value, last_line = parse_tag(line)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line695">695</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line696">696</a>       raise SyntaxError.new(&quot;Illegal element: classes and ids must have values.&quot;) if attributes =~ /[\.#](\.|#|\z)/</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line697">697</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line698">698</a>       # Get rid of whitespace outside of the tag if we need to</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line699">699</a>       rstrip_buffer! if nuke_outer_whitespace</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line700">700</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line701">701</a>       preserve_tag = options[:preserve].include?(tag_name)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line702">702</a>       nuke_inner_whitespace ||= preserve_tag</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line703">703</a>       preserve_tag &amp;&amp;= !options[:ugly]</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line704">704</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line705">705</a>       escape_html = (action == '&amp;' || (action != '!' &amp;&amp; @options[:escape_html]))</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line706">706</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line707">707</a>       case action</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line708">708</a>       when '/'; self_closing = true</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line709">709</a>       when '~'; parse = preserve_script = true</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line710">710</a>       when '='</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line711">711</a>         parse = true</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line712">712</a>         if value[0] == ?=</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line713">713</a>           value = unescape_interpolation(value[1..-1].strip, :escape_html =&gt; escape_html)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line714">714</a>           escape_html = false</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line715">715</a>         end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line716">716</a>       when '&amp;', '!'</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line717">717</a>         if value[0] == ?= || value[0] == ?~</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line718">718</a>           parse = true</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line719">719</a>           preserve_script = (value[0] == ?~)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line720">720</a>           if value[1] == ?=</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line721">721</a>             value = unescape_interpolation(value[2..-1].strip, :escape_html =&gt; escape_html)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line722">722</a>             escape_html = false</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line723">723</a>           else</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line724">724</a>             value = value[1..-1].strip</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line725">725</a>           end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line726">726</a>         elsif contains_interpolation?(value)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line727">727</a>           value = unescape_interpolation(value, :escape_html =&gt; escape_html)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line728">728</a>           parse = true</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line729">729</a>           escape_html = false</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line730">730</a>         end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line731">731</a>       else</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line732">732</a>         if contains_interpolation?(value)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line733">733</a>           value = unescape_interpolation(value, :escape_html =&gt; escape_html)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line734">734</a>           parse = true</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line735">735</a>           escape_html = false</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line736">736</a>         end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line737">737</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line738">738</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line739">739</a>       if parse &amp;&amp; @options[:suppress_eval]</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line740">740</a>         parse = false</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line741">741</a>         value = ''</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line742">742</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line743">743</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line744">744</a>       object_ref = &quot;nil&quot; if object_ref.nil? || @options[:suppress_eval]</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line745">745</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line746">746</a>       attributes = parse_class_and_id(attributes)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line747">747</a>       attributes_hashes.map! do |syntax, attributes_hash|</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line748">748</a>         if syntax == :old</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line749">749</a>           static_attributes = parse_static_hash(attributes_hash)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line750">750</a>           attributes_hash = nil if static_attributes || @options[:suppress_eval]</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line751">751</a>         else</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line752">752</a>           static_attributes, attributes_hash = attributes_hash</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line753">753</a>         end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line754">754</a>         Buffer.merge_attrs(attributes, static_attributes) if static_attributes</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line755">755</a>         attributes_hash</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line756">756</a>       end.compact!</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line757">757</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line758">758</a>       raise SyntaxError.new(&quot;Illegal nesting: nesting within a self-closing tag is illegal.&quot;, @next_line.index) if block_opened? &amp;&amp; self_closing</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line759">759</a>       raise SyntaxError.new(&quot;Illegal nesting: content can't be both given on the same line as %#{tag_name} and nested within it.&quot;, @next_line.index) if block_opened? &amp;&amp; !value.empty?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line760">760</a>       raise SyntaxError.new(&quot;There's no Ruby code for #{action} to evaluate.&quot;, last_line - 1) if parse &amp;&amp; value.empty?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line761">761</a>       raise SyntaxError.new(&quot;Self-closing tags can't have content.&quot;, last_line - 1) if self_closing &amp;&amp; !value.empty?</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line762">762</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line763">763</a>       self_closing ||= !!( !block_opened? &amp;&amp; value.empty? &amp;&amp; @options[:autoclose].include?(tag_name) )</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line764">764</a>       value = nil if value.empty? &amp;&amp; (block_opened? || self_closing)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line765">765</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line766">766</a>       dont_indent_next_line =</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line767">767</a>         (nuke_outer_whitespace &amp;&amp; !block_opened?) ||</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line768">768</a>         (nuke_inner_whitespace &amp;&amp; block_opened?)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line769">769</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line770">770</a>       # Check if we can render the tag directly to text and not process it in the buffer</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line771">771</a>       if object_ref == &quot;nil&quot; &amp;&amp; attributes_hashes.empty? &amp;&amp; !preserve_script</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line772">772</a>         tag_closed = !block_opened? &amp;&amp; !self_closing &amp;&amp; !parse</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line773">773</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line774">774</a>         open_tag  = prerender_tag(tag_name, self_closing, attributes)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line775">775</a>         if tag_closed</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line776">776</a>           open_tag &lt;&lt; &quot;#{value}&lt;/#{tag_name}&gt;&quot;</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line777">777</a>           open_tag &lt;&lt; &quot;\n&quot; unless nuke_outer_whitespace</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line778">778</a>         else</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line779">779</a>           open_tag &lt;&lt; &quot;\n&quot; unless parse || nuke_inner_whitespace || (self_closing &amp;&amp; nuke_outer_whitespace)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line780">780</a>         end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line781">781</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line782">782</a>         push_merged_text(open_tag, tag_closed || self_closing || nuke_inner_whitespace ? 0 : 1,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line783">783</a>                          !nuke_outer_whitespace)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line784">784</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line785">785</a>         @dont_indent_next_line = dont_indent_next_line</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line786">786</a>         return if tag_closed</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line787">787</a>       else</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line788">788</a>         flush_merged_text</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line789">789</a>         content = parse ? 'nil' : value.inspect</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line790">790</a>         if attributes_hashes.empty?</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line791">791</a>           attributes_hashes = ''</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line792">792</a>         elsif attributes_hashes.size == 1</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line793">793</a>           attributes_hashes = &quot;, #{attributes_hashes.first}&quot;</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line794">794</a>         else</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line795">795</a>           attributes_hashes = &quot;, (#{attributes_hashes.join(&quot;).merge(&quot;)})&quot;</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line796">796</a>         end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line797">797</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line798">798</a>         args = [tag_name, self_closing, !block_opened?, preserve_tag, escape_html,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line799">799</a>                 attributes, nuke_outer_whitespace, nuke_inner_whitespace</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line800">800</a>                ].map { |v| v.inspect }.join(', ')</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line801">801</a>         push_silent &quot;_hamlout.open_tag(#{args}, #{object_ref}, #{content}#{attributes_hashes})&quot;</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line802">802</a>         @dont_tab_up_next_text = @dont_indent_next_line = dont_indent_next_line</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line803">803</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line804">804</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line805">805</a>       return if self_closing</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line806">806</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line807">807</a>       if value.nil?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line808">808</a>         push_and_tabulate([:element, [tag_name, nuke_outer_whitespace, nuke_inner_whitespace]])</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line809">809</a>         @output_tabs += 1 unless nuke_inner_whitespace</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line810">810</a>         return</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line811">811</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line812">812</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line813">813</a>       if parse</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line814">814</a>         push_script(value, :preserve_script =&gt; preserve_script, :in_tag =&gt; true,</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line815">815</a>           :preserve_tag =&gt; preserve_tag, :escape_html =&gt; escape_html,</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line816">816</a>           :nuke_inner_whitespace =&gt; nuke_inner_whitespace)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line817">817</a>         concat_merged_text(&quot;&lt;/#{tag_name}&gt;&quot; + (nuke_outer_whitespace ? &quot;&quot; : &quot;\n&quot;))</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line818">818</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line819">819</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line820">820</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line821">821</a>     # Renders a line that creates an XHTML tag and has an implicit div because of</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line822">822</a>     # `.` or `#`.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line823">823</a>     def render_div(line)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line824">824</a>       render_tag('%div' + line)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line825">825</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line826">826</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line827">827</a>     # Renders an XHTML comment.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line828">828</a>     def render_comment(line)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line829">829</a>       conditional, line = balance(line, ?[, ?]) if line[0] == ?[</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line830">830</a>       line.strip!</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line831">831</a>       conditional &lt;&lt; &quot;&gt;&quot; if conditional</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line832">832</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line833">833</a>       if block_opened? &amp;&amp; !line.empty?</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line834">834</a>         raise SyntaxError.new('Illegal nesting: nesting within a tag that already has content is illegal.', @next_line.index)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line835">835</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line836">836</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line837">837</a>       open = &quot;&lt;!--#{conditional}&quot;</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line838">838</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line839">839</a>       # Render it statically if possible</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line840">840</a>       unless line.empty?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line841">841</a>         return push_text(&quot;#{open} #{line} #{conditional ? &quot;&lt;![endif]--&gt;&quot; : &quot;--&gt;&quot;}&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line842">842</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line843">843</a> </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line844">844</a>       push_text(open, 1)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line845">845</a>       @output_tabs += 1</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line846">846</a>       push_and_tabulate([:comment, !conditional.nil?])</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line847">847</a>       unless line.empty?</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line848">848</a>         push_text(line)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line849">849</a>         close</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line850">850</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line851">851</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line852">852</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line853">853</a>     # Renders an XHTML doctype or XML shebang.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line854">854</a>     def render_doctype(line)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line855">855</a>       raise SyntaxError.new(&quot;Illegal nesting: nesting within a header command is illegal.&quot;, @next_line.index) if block_opened?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line856">856</a>       doctype = text_for_doctype(line)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line857">857</a>       push_text doctype if doctype</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line858">858</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line859">859</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line860">860</a>     def text_for_doctype(text)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line861">861</a>       text = text[3..-1].lstrip.downcase</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line862">862</a>       if text.index(&quot;xml&quot;) == 0</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line863">863</a>         return nil if html?</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line864">864</a>         wrapper = @options[:attr_wrapper]</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line865">865</a>         return &quot;&lt;?xml version=#{wrapper}1.0#{wrapper} encoding=#{wrapper}#{text.split(' ')[1] || &quot;utf-8&quot;}#{wrapper} ?&gt;&quot;</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line866">866</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line867">867</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line868">868</a>       if html5?</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line869">869</a>         '&lt;!DOCTYPE html&gt;'</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line870">870</a>       else</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line871">871</a>         version, type = text.scan(DOCTYPE_REGEX)[0]</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line872">872</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line873">873</a>         if xhtml?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line874">874</a>           if version == &quot;1.1&quot;</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line875">875</a>             '&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.1//EN&quot; &quot;http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd&quot;&gt;'</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line876">876</a>           elsif version == &quot;5&quot;</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line877">877</a>             '&lt;!DOCTYPE html&gt;'</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line878">878</a>           else</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line879">879</a>             case type</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line880">880</a>             when &quot;strict&quot;;   '&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Strict//EN&quot; &quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd&quot;&gt;'</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line881">881</a>             when &quot;frameset&quot;; '&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Frameset//EN&quot; &quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-frameset.dtd&quot;&gt;'</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line882">882</a>             when &quot;mobile&quot;;   '&lt;!DOCTYPE html PUBLIC &quot;-//WAPFORUM//DTD XHTML Mobile 1.2//EN&quot; &quot;http://www.openmobilealliance.org/tech/DTD/xhtml-mobile12.dtd&quot;&gt;'</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line883">883</a>             when &quot;basic&quot;;    '&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML Basic 1.1//EN&quot; &quot;http://www.w3.org/TR/xhtml-basic/xhtml-basic11.dtd&quot;&gt;'</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line884">884</a>             else             '&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot; &quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd&quot;&gt;'</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line885">885</a>             end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line886">886</a>           end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line887">887</a> </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line888">888</a>         elsif html4?</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line889">889</a>           case type</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line890">890</a>           when &quot;strict&quot;;   '&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD HTML 4.01//EN&quot; &quot;http://www.w3.org/TR/html4/strict.dtd&quot;&gt;'</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line891">891</a>           when &quot;frameset&quot;; '&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD HTML 4.01 Frameset//EN&quot; &quot;http://www.w3.org/TR/html4/frameset.dtd&quot;&gt;'</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line892">892</a>           else             '&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD HTML 4.01 Transitional//EN&quot; &quot;http://www.w3.org/TR/html4/loose.dtd&quot;&gt;'</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line893">893</a>           end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line894">894</a>         end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line895">895</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line896">896</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line897">897</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line898">898</a>     # Starts a filtered block.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line899">899</a>     def start_filtered(name)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line900">900</a>       raise Error.new(&quot;Invalid filter name \&quot;:#{name}\&quot;.&quot;) unless name =~ /^\w+$/</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line901">901</a>       raise Error.new(&quot;Filter \&quot;#{name}\&quot; is not defined.&quot;) unless filter = Filters.defined[name]</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line902">902</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line903">903</a>       push_and_tabulate([:filtered, filter])</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line904">904</a>       @flat = true</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line905">905</a>       @filter_buffer = String.new</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line906">906</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line907">907</a>       # If we don't know the indentation by now, it'll be set in Line#tabs</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line908">908</a>       @flat_spaces = @indentation * @template_tabs if @indentation</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line909">909</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line910">910</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line911">911</a>     def raw_next_line</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line912">912</a>       text = @template.shift</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line913">913</a>       return unless text</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line914">914</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line915">915</a>       index = @template_index</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line916">916</a>       @template_index += 1</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line917">917</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line918">918</a>       return text, index</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line919">919</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line920">920</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line921">921</a>     def next_line</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line922">922</a>       text, index = raw_next_line</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line923">923</a>       return unless text</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line924">924</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line925">925</a>       # :eod is a special end-of-document marker</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line926">926</a>       line =</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line927">927</a>         if text == :eod</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line928">928</a>           Line.new '-#', '-#', '-#', index, self, true</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line929">929</a>         else</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line930">930</a>           Line.new text.strip, text.lstrip.chomp, text, index, self, false</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line931">931</a>         end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line932">932</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line933">933</a>       # `flat?' here is a little outdated,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line934">934</a>       # so we have to manually check if either the previous or current line</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line935">935</a>       # closes the flat block,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line936">936</a>       # as well as whether a new block is opened</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line937">937</a>       @line.tabs if @line</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line938">938</a>       unless (flat? &amp;&amp; !closes_flat?(line) &amp;&amp; !closes_flat?(@line)) ||</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line939">939</a>           (@line &amp;&amp; @line.text[0] == ?: &amp;&amp; line.full =~ %r[^#{@line.full[/^\s+/]}\s])</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line940">940</a>         if line.text.empty?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line941">941</a>           newline</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line942">942</a>           return next_line</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line943">943</a>         end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line944">944</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line945">945</a>         handle_multiline(line)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line946">946</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line947">947</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line948">948</a>       @next_line = line</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line949">949</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line950">950</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line951">951</a>     def closes_flat?(line)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line952">952</a>       line &amp;&amp; !line.text.empty? &amp;&amp; line.full !~ /^#{@flat_spaces}/</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line953">953</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line954">954</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line955">955</a>     def un_next_line(line)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line956">956</a>       @template.unshift line</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line957">957</a>       @template_index -= 1</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line958">958</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line959">959</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line960">960</a>     def handle_multiline(line)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line961">961</a>       if is_multiline?(line.text)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line962">962</a>         line.text.slice!(-1)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line963">963</a>         while new_line = raw_next_line.first</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line964">964</a>           break if new_line == :eod</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line965">965</a>           newline and next if new_line.strip.empty?</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line966">966</a>           break unless is_multiline?(new_line.strip)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line967">967</a>           line.text &lt;&lt; new_line.strip[0...-1]</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line968">968</a>           newline</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line969">969</a>         end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line970">970</a>         un_next_line new_line</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line971">971</a>         resolve_newlines</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line972">972</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line973">973</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line974">974</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line975">975</a>     # Checks whether or not +line+ is in a multiline sequence.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line976">976</a>     def is_multiline?(text)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line977">977</a>       text &amp;&amp; text.length &gt; 1 &amp;&amp; text[-1] == MULTILINE_CHAR_VALUE &amp;&amp; text[-2] == ?\s</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line978">978</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line979">979</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line980">980</a>     def contains_interpolation?(str)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line981">981</a>       str.include?('#{')</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line982">982</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line983">983</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line984">984</a>     def unescape_interpolation(str, opts = {})</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line985">985</a>       res = ''</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line986">986</a>       rest = Haml::Shared.handle_interpolation str.dump do |scan|</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line987">987</a>         escapes = (scan[2].size - 1) / 2</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line988">988</a>         res &lt;&lt; scan.matched[0...-3 - escapes]</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line989">989</a>         if escapes % 2 == 1</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line990">990</a>           res &lt;&lt; '#{'</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line991">991</a>         else</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line992">992</a>           content = eval('&quot;' + balance(scan, ?{, ?}, 1)[0][0...-1] + '&quot;')</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line993">993</a>           content = &quot;Haml::Helpers.html_escape(#{content})&quot; if opts[:escape_html]</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line994">994</a>           res &lt;&lt; '#{' + content + &quot;}&quot;# Use eval to get rid of string escapes</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line995">995</a>         end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line996">996</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line997">997</a>       res + rest</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line998">998</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line999">999</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1000">1000</a>     def balance(*args)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1001">1001</a>       res = Haml::Shared.balance(*args)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1002">1002</a>       return res if res</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1003">1003</a>       raise SyntaxError.new(&quot;Unbalanced brackets.&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1004">1004</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1005">1005</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1006">1006</a>     def block_opened?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1007">1007</a>       !flat? &amp;&amp; @next_line.tabs &gt; @line.tabs</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1008">1008</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1009">1009</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1010">1010</a>     # Pushes value onto `@to_close_stack` and increases</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1011">1011</a>     # `@template_tabs`.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1012">1012</a>     def push_and_tabulate(value)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1013">1013</a>       @to_close_stack.push(value)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1014">1014</a>       @template_tabs += 1</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1015">1015</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1016">1016</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1017">1017</a>     def flat?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1018">1018</a>       @flat</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1019">1019</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1020">1020</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1021">1021</a>     def newline</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1022">1022</a>       @newlines += 1</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1023">1023</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1024">1024</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1025">1025</a>     def newline_now</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1026">1026</a>       @precompiled &lt;&lt; &quot;\n&quot;</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1027">1027</a>       @newlines -= 1</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1028">1028</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1029">1029</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1030">1030</a>     def resolve_newlines</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1031">1031</a>       return unless @newlines &gt; 0</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1032">1032</a>       flush_merged_text unless @to_merge.all? {|type, *_| type == :text}</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1033">1033</a>       @precompiled &lt;&lt; &quot;\n&quot; * @newlines</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1034">1034</a>       @newlines = 0</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1035">1035</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1036">1036</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1037">1037</a>     # Get rid of and whitespace at the end of the buffer</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1038">1038</a>     # or the merged text</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1039">1039</a>     def rstrip_buffer!(index = -1)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1040">1040</a>       last = @to_merge[index]</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1041">1041</a>       if last.nil?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1042">1042</a>         push_silent(&quot;_hamlout.rstrip!&quot;, false)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1043">1043</a>         @dont_tab_up_next_text = true</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1044">1044</a>         return</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line1045">1045</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1046">1046</a> </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1047">1047</a>       case last.first</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1048">1048</a>       when :text</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1049">1049</a>         last[1].rstrip!</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1050">1050</a>         if last[1].empty?</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1051">1051</a>           @to_merge.slice! index</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1052">1052</a>           rstrip_buffer! index</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1053">1053</a>         end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1054">1054</a>       when :script</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1055">1055</a>         last[1].gsub!(/\(haml_temp, (.*?)\);$/, '(haml_temp.rstrip, \1);')</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1056">1056</a>         rstrip_buffer! index - 1</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1057">1057</a>       else</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1058">1058</a>         raise SyntaxError.new(&quot;[HAML BUG] Undefined entry in Haml::Precompiler@to_merge.&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1059">1059</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1060">1060</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1061">1061</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line1062">1062</a> end</pre></td>
          </tr>
        
      </tbody>
    </table>

    <p>Generated on Wed Mar 03 16:18:01 -0300 2010 with <a href="http://github.com/relevance/rcov">rcov 0.9.2.1</a></p>

  </body>
</html>
